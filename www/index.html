<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a2a6c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Comprehensive Health & Fitness Assessment</title>
    <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="css/dataTables.min.css">
    <link rel="stylesheet" href="css/fontawesome.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary-color: #007aff; --success-color: #4cd964; 
            --warning-color: #ff9500; --danger-color: #ff3b30;
            --light-gray: #f7f7f7; --dark-gray: #8e8e93; --text-color: #333;
            --border-radius: 10px; --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        body { font-family: -apple-system, sans-serif; background: var(--light-gray); color: var(--text-color); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--shadow); overflow: hidden; }
        .card-header { background: var(--primary-color); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .card-content { padding: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 16px; }
        .form-input-small { padding: 8px; font-size: 14px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        .form-section { margin: 20px 0; }
        .form-section-title { font-weight: bold; margin-bottom: 10px; color: var(--primary-color); padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .error { color: var(--danger-color); font-size: 12px; margin-top: 5px; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; text-align: center; display: inline-block; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-icon { padding: 8px; border-radius: 6px; min-width: 36px; }
        .btn-block { width: 100%; }
        .btn-history-action  { border: none; margin-bottom: 5px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .result-card { background: white; border-radius: var(--border-radius); padding: 15px; text-align: center; box-shadow: var(--shadow); border-left: 4px solid var(--primary-color); }
        .result-value { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .result-label { font-size: 14px; color: var(--dark-gray); margin-top: 5px; }
        .accordion { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); margin-bottom: 15px; }
        .accordion-header { padding: 15px; background: #f7f7f7; border-bottom: 1px solid #e0e0e0; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-content { padding: 0; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .accordion-content.active { padding: 15px; max-height: 2000px; }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion.active .accordion-icon { transform: rotate(180deg); }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; overflow-x: auto; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .classification { margin-top: 10px; padding: 8px; border-radius: 5px; text-align: center; font-weight: bold; }
        .classification-normal { background: #d4edda; color: #155724; }
        .classification-warning { background: #fff3cd; color: #856404; }
        .classification-danger { background: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #f7f7f7; font-weight: 600; }
        .composition-table { width: 100%; margin: 15px 0; }
        .composition-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .composition-table .component { font-weight: 500; }
        .composition-table .value { text-align: right; font-weight: bold; }
        .composition-table .percent { text-align: center; color: var(--dark-gray); }
        .assessment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .assessment-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); }
        .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .metric-name { font-weight: 500; }
        .metric-value { font-weight: bold; }
        .zone-visual { margin: 15px 0; }
        .zone-bar { height: 24px; background: #e9ecef; border-radius: 12px; margin: 5px 0; position: relative; overflow: hidden; }
        .zone-segment { height: 100%; display: inline-block; }
        .zone-label { position: absolute; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.3); }
        .summary-panel { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: var(--border-radius); padding: 25px; margin: 20px 0; }
        .summary-score { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
        .summary-text { text-align: center; font-size: 18px; opacity: 0.9; }
        .validation-error { border-color: var(--danger-color) !important; }
        
        /* History specific styles */
        .history-controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .history-table-container { overflow-x: auto; }
        .chart-container { margin: 20px 0; background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); }
        .chart-title { font-weight: bold; margin-bottom: 15px; color: var(--primary-color); }
        .history-comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .comparison-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); }
        .comparison-value { font-size: 20px; font-weight: bold; text-align: center; margin: 10px 0; }
        .comparison-change { text-align: center; font-size: 14px; }
        .positive-change { color: var(--success-color); }
        .negative-change { color: var(--danger-color); }
        .no-change { color: var(--dark-gray); }
        .date-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .session-date { font-weight: bold; color: var(--primary-color); }
        .session-actions { display: flex; gap: 5px; }
        .export-options { display: flex; gap: 10px; margin-top: 15px; }
        .dataTables_wrapper { margin-top: 15px; }
        
        #historyTable {
            width: 100% !important;
            table-layout: fixed;
        }
        #historyTable th {
            min-width: 100px;
        }
        #historyTable:not(.display) {
            display: table;
        }
        #historyTable:not(.display) th,
        #historyTable:not(.display) td {
            border: 1px solid #dee2e6;
            padding: 8px;
        }

        /* Mobile responsive tables */
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .history-controls { flex-direction: column; }
            .btn { width: 100%; margin-bottom: 5px; }
            .btn-icon {
                padding: 6px;
                min-width: 32px;
            }
            .btn-history-action  { border: none; margin-bottom: 5px; }
            .dataTables_wrapper .dataTables_scroll {
                overflow-x: auto;
            }
            .dataTables_wrapper .dataTables_paginate .paginate_button {
                padding: 5px 8px;
                margin: 0 2px;
            }
            .export-options { flex-direction: column; }
            .history-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .session-actions .btn-icon {
                padding: 6px 8px;
                min-width: 36px;
                font-size: 12px;
            }
            #historyTable {
                table-layout: auto !important;
            }
            #historyTable th:nth-child(8),
            #historyTable td:nth-child(8) {
                min-width: 120px;
                max-width: 120px;
                width: 120px;
            }
            #historyTable th, #historyTable td {
                padding: 8px 5px;
                font-size: 14px;
            }
            #historyTable td:last-child {
                position: relative;
                overflow: visible;
            }
            #historyTable td:last-child .session-actions {
                display: flex;
                flex-wrap: nowrap;
                gap: 4px;
                justify-content: flex-start;
                min-width: 110px;
            }
        }

        /* Language selector styles */
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .language-selector label {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .language-selector select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #007aff;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Comprehensive Health & Fitness Assessment</h1>
            <p>Complete anthropometric, metabolic, and cardiovascular evaluation with personalized prescriptions and history tracking</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="composition">Body Composition</div>
            <div class="tab" data-tab="health">Health Metrics</div>
            <div class="tab" data-tab="fitness">Fitness Assessment</div>
            <div class="tab" data-tab="summary">Comprehensive Summary</div>
            <div class="tab" data-tab="prescription">Exercise Prescription</div>
            <div class="tab" data-tab="history">History & Progress</div>
        </div>

        <!-- Tab 1: Body Composition -->
        <div id="tab-composition" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    Complete Body Composition Analysis
                    <div>
                        <button class="btn btn-success btn-small" onclick="saveCurrentSession()">
                            <i class="fas fa-save"></i> Save Session
                        </button>
                        <button class="btn btn-primary btn-small" onclick="loadLatestSession()">
                            <i class="fas fa-history"></i> Load Last
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Height (cm)</label>
                            <input type="number" id="heightCm" class="form-input" placeholder="E.g.: 175" min="100" max="250" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" id="weightKg" class="form-input" placeholder="E.g.: 70" min="30" max="300" data-validate="true">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Age (years)</label>
                            <input type="number" id="ageYears" class="form-input" placeholder="E.g.: 30" min="15" max="100" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sex</label>
                            <select id="sex" class="form-input">
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Waist Circumference (cm)</label>
                            <input type="number" id="waistCm" class="form-input" placeholder="E.g.: 80" min="50" max="200" data-validate="true">
                            <div class="error">Measured at navel level</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hip Circumference (cm)</label>
                            <input type="number" id="hipCm" class="form-input" placeholder="E.g.: 95" min="50" max="200" data-validate="true">
                            <div class="error">Measured at widest point</div>
                        </div>
                    </div>

                    <div class="accordion active">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            Bone Diameters (for bone mass calculation)
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content active">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Wrist Diameter (cm)</label>
                                    <input type="number" id="diameterRadio" class="form-input" placeholder="E.g.: 5.2" step="0.1" min="4" max="8">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Knee Diameter (cm)</label>
                                    <input type="number" id="diameterFemur" class="form-input" placeholder="E.g.: 9.5" step="0.1" min="7" max="12">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            Skinfolds (Jackson &amp; Pollock - 7 sites)
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Triceps (mm)</label>
                                    <input type="number" id="sfTriceps" class="form-input form-input-small" placeholder="12">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subscapular (mm)</label>
                                    <input type="number" id="sfSubscapular" class="form-input form-input-small" placeholder="15">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mid-Axillary (mm)</label>
                                    <input type="number" id="sfAxillary" class="form-input form-input-small" placeholder="10">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Pectoral (mm)</label>
                                    <input type="number" id="sfPectoral" class="form-input form-input-small" placeholder="8">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Abdominal (mm)</label>
                                    <input type="number" id="sfAbdominal" class="form-input form-input-small" placeholder="20">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Suprailiac (mm)</label>
                                    <input type="number" id="sfSuprailiac" class="form-input form-input-small" placeholder="18">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Thigh (mm)</label>
                                    <input type="number" id="sfThigh" class="form-input form-input-small" placeholder="16">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <button class="btn btn-primary btn-block" onclick="calculateComposition()">Calculate Body Composition</button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success btn-block" onclick="saveCurrentSession()">
                                <i class="fas fa-save"></i> Save & Calculate
                            </button>
                        </div>
                    </div>

                    <div id="resultsComposition" style="display: none;">
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-value" id="resultBmi">-</div>
                                <div class="result-label">BMI</div>
                                <div id="bmiClassification" class="classification"></div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultWhr">-</div>
                                <div class="result-label">WHR</div>
                                <div id="whrClassification" class="classification"></div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultBodyfatPercent">-</div>
                                <div class="result-label">Body Fat %</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultIdealWeight">-</div>
                                <div class="result-label">Ideal Weight</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">üìä 4-Component Body Composition</div>
                            <table class="composition-table">
                                <tr>
                                    <td class="component">Total Weight</td>
                                    <td class="value" id="compTotalWeight">- kg</td>
                                    <td class="percent">100%</td>
                                </tr>
                                <tr>
                                    <td class="component">Fat Mass</td>
                                    <td class="value" id="compFatMass">- kg</td>
                                    <td class="percent" id="compFatPercent">-</td>
                                </tr>
                                <tr>
                                    <td class="component">Bone Mass</td>
                                    <td class="value" id="compBoneMass">- kg</td>
                                    <td class="percent" id="compBonePercent">-</td>
                                </tr>
                                <tr>
                                    <td class="component">Muscle Mass</td>
                                    <td class="value" id="compMuscleMass">- kg</td>
                                    <td class="percent" id="compMusclePercent">-</td>
                                </tr>
                                <tr>
                                    <td class="component">Residual Weight</td>
                                    <td class="value" id="compResidualWeight">- kg</td>
                                    <td class="percent" id="compResidualPercent">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Health Metrics -->
        <div id="tab-health" class="tab-content">
            <div class="card">
                <div class="card-header">Health Metrics & Cardiovascular Assessment</div>
                <div class="card-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Resting Heart Rate (bpm)</label>
                            <input type="number" id="restingHR" class="form-input" placeholder="E.g.: 65" min="40" max="120" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Systolic BP (mmHg)</label>
                            <input type="number" id="systolicBP" class="form-input" placeholder="E.g.: 120" min="80" max="200" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Diastolic BP (mmHg)</label>
                            <input type="number" id="diastolicBP" class="form-input" placeholder="E.g.: 80" min="50" max="130" data-validate="true">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Blood Glucose (mg/dL)</label>
                            <input type="number" id="bloodGlucose" class="form-input" placeholder="E.g.: 95" min="50" max="300" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Total Cholesterol (mg/dL)</label>
                            <input type="number" id="totalCholesterol" class="form-input" placeholder="E.g.: 180" min="100" max="400" data-validate="true">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Activity Level</label>
                            <select id="activityLevel" class="form-input">
                                <option value="sedentary">Sedentary</option>
                                <option value="light">Lightly Active</option>
                                <option value="moderate">Moderately Active</option>
                                <option value="active">Very Active</option>
                                <option value="athlete">Athlete</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="calculateHealthMetrics()">Calculate Health Metrics</button>

                    <div id="resultsHealth" style="display: none;">
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-value" id="resultBMR">-</div>
                                <div class="result-label">BMR (kcal/day)</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultVO2Max">-</div>
                                <div class="result-label">VO‚ÇÇ Max (est.)</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultBP">-</div>
                                <div class="result-label">Blood Pressure</div>
                                <div id="bpClassification" class="classification"></div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultCholesterol">-</div>
                                <div class="result-label">Cholesterol</div>
                                <div id="cholClassification" class="classification"></div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">ü©∫ Health Risk Assessment</div>
                            <div id="healthAssessment"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Fitness Assessment -->
        <div id="tab-fitness" class="tab-content">
            <div class="card">
                <div class="card-header">Fitness & Aerobic Zone Analysis</div>
                <div class="card-content">
                    <div class="form-section">
                        <div class="form-section-title">Strength Assessment</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Bench Press 1RM (kg)</label>
                                <input type="number" id="rmBench" class="form-input" placeholder="E.g.: 60" min="20" max="300">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Squat 1RM (kg)</label>
                                <input type="number" id="rmSquat" class="form-input" placeholder="E.g.: 80" min="20" max="400">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Goal Setting</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Primary Goal</label>
                                <select id="goal" class="form-input">
                                    <option value="fat_loss">Fat Loss</option>
                                    <option value="muscleGain">Muscle Gain</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="strength">Strength</option>
                                    <option value="cardio">Cardiovascular Health</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="calculateFitnessAssessment()">Analyze Fitness Profile</button>

                    <div id="resultsFitness" style="display: none;">
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-value" id="resultMaxHR">-</div>
                                <div class="result-label">Max Heart Rate</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultTargetHR">-</div>
                                <div class="result-label">Target HR Zone</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultTDEE">-</div>
                                <div class="result-label">TDEE (kcal/day)</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultStrengthScore">-</div>
                                <div class="result-label">Strength Ratio</div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">üéØ Aerobic Training Zones</div>
                            <div class="zone-visual">
                                <div id="zoneVisualization"></div>
                            </div>
                            <div id="zoneDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Comprehensive Summary -->
        <div id="tab-summary" class="tab-content">
            <div class="card">
                <div class="card-header">Comprehensive Health Summary</div>
                <div class="card-content">
                    <div class="summary-panel" id="summaryPanel">
                        <div class="summary-score" id="overallScore">-</div>
                        <div class="summary-text" id="overallAssessment">Complete assessment to see results</div>
                    </div>

                    <div class="assessment-grid">
                        <div class="assessment-card">
                            <div class="form-section-title">üìä Body Composition</div>
                            <div id="summaryComposition"></div>
                        </div>
                        <div class="assessment-card">
                            <div class="form-section-title">ü©∫ Health Metrics</div>
                            <div id="summaryHealth"></div>
                        </div>
                    </div>

                    <div class="assessment-grid">
                        <div class="assessment-card">
                            <div class="form-section-title">üéØ Fitness Assessment</div>
                            <div id="summaryFitness"></div>
                        </div>
                        <div class="assessment-card">
                            <div class="form-section-title">‚ö†Ô∏è Risk Factors</div>
                            <div id="summaryRisks"></div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="generateComprehensiveSummary()">Generate Complete Assessment</button>
                </div>
            </div>
        </div>

        <!-- Tab 5: Exercise Prescription -->
        <div id="tab-prescription" class="tab-content">
            <div class="card">
                <div class="card-header">Personalized Exercise Prescription</div>
                <div class="card-content">
                    <div id="prescriptionDynamicInputs"></div>
                    
                    <button class="btn btn-primary" onclick="generatePrescription()">Generate Full Prescription</button>

                    <div id="resultsPrescription" style="display: none;">
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-value" id="resultCaloricTarget">-</div>
                                <div class="result-label">Daily Calories</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultTimeframe">-</div>
                                <div class="result-label">Timeframe</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultWeeklyGoal">-</div>
                                <div class="result-label">Weekly Target</div>
                            </div>
                            <div class="result-card">
                                <div class="result-value" id="resultRiskScore">-</div>
                                <div class="result-label">Health Risk Score</div>
                            </div>
                        </div>

                        <div class="assessment-grid">
                            <div class="assessment-card">
                                <div class="form-section-title">üíì Cardiovascular Prescription</div>
                                <div id="prescriptionCardio"></div>
                            </div>
                            <div class="assessment-card">
                                <div class="form-section-title">üèãÔ∏è Strength Prescription</div>
                                <div id="prescriptionStrength"></div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">üí° Specific Recommendations</div>
                            <div id="prescriptionRecommendations"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW Tab 6: History & Progress -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <div class="card-header">
                    History & Progress Tracking
                    <div>
                        <button class="btn btn-primary btn-small" onclick="refreshHistory()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="history-controls">
                        <button class="btn btn-success" onclick="saveCurrentSession()">
                            <i class="fas fa-save"></i> Save Current Session
                        </button>
                        <button class="btn btn-primary" onclick="loadLatestSession()">
                            <i class="fas fa-history"></i> Load Latest Session
                        </button>
                        <button class="btn btn-warning" onclick="exportHistoryToCSV()">
                            <i class="fas fa-download"></i> Export to CSV
                        </button>
                        <button class="btn btn-danger" onclick="clearAllHistory()">
                            <i class="fas fa-trash"></i> Clear All History
                        </button>
                        <select id="historyFilter" class="form-input" style="max-width: 200px;" onchange="filterHistory()">
                            <option value="all">All Sessions</option>
                            <option value="last7">Last 7 days</option>
                            <option value="last30">Last 30 days</option>
                            <option value="last90">Last 90 days</option>
                        </select>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">
                            <span>üìà Progress Charts</span>
                            <select id="chartMetric" class="form-input" style="max-width: 200px;" onchange="updateProgressChart()">
                                <option value="weight">Weight (kg)</option>
                                <option value="bmi">BMI</option>
                                <option value="bodyfat">Body Fat %</option>
                                <option value="whr">Waist-Hip Ratio</option>
                                <option value="restingHR">Resting HR</option>
                                <option value="vo2max">VO‚ÇÇ Max</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üìä Session Comparison</div>
                        <div class="history-comparison" id="historyComparison">
                            <div class="comparison-card">
                                <div class="form-section-title">Weight (kg)</div>
                                <div class="comparison-value" id="comparisonWeight">-</div>
                                <div class="comparison-change" id="comparisonWeightChange">-</div>
                            </div>
                            <div class="comparison-card">
                                <div class="form-section-title">Body Fat %</div>
                                <div class="comparison-value" id="comparisonBodyfat">-</div>
                                <div class="comparison-change" id="comparisonBodyfatChange">-</div>
                            </div>
                            <div class="comparison-card">
                                <div class="form-section-title">BMI</div>
                                <div class="comparison-value" id="comparisonBMI">-</div>
                                <div class="comparison-change" id="comparisonBMIChange">-</div>
                            </div>
                            <div class="comparison-card">
                                <div class="form-section-title">WHR</div>
                                <div class="comparison-value" id="comparisonWHR">-</div>
                                <div class="comparison-change" id="comparisonWHRChange">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">üìã Session History</div>
                        <div class="history-table-container">
                            <table id="historyTable" class="display">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Weight (kg)</th>
                                        <th>BMI</th>
                                        <th>Body Fat %</th>
                                        <th>WHR</th>
                                        <th>Rest HR</th>
                                        <th>VO‚ÇÇ Max</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="export-options">
                        <button class="btn btn-warning" onclick="exportHistoryToCSV()">
                            <i class="fas fa-file-csv"></i> Export to CSV
                        </button>
                        <button class="btn btn-primary" onclick="exportHistoryToJSON()">
                            <i class="fas fa-file-code"></i> Export to JSON
                        </button>
                        <button class="btn btn-primary" onclick="importHistoryFromJSON()">
                            <i class="fas fa-upload"></i> Import from JSON
                        </button>
                        <button class="btn btn-danger" onclick="clearAllHistory()">
                            <i class="fas fa-trash"></i> Clear All History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer style="margin-top: 40px; padding: 20px; text-align: center; color: var(--dark-gray); font-size: 14px; border-top: 1px solid #e0e0e0;">
        <p style="margin-bottom: 10px;">
            &copy; 2025 Roberto Luiz Souza Monteiro. All rights reserved.
        </p>
        <p style="margin-bottom: 10px;">
            <a href="https://github.com/souzamonteiro/fitlogwebapp.git" 
                target="_blank"
                style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 6px;"
                onmouseover="this.style.textDecoration='underline'"
                onmouseout="this.style.textDecoration='none'">
                <i class="fa-brands fa-github"></i>
                View source code on GitHub
            </a>
        </p>
        <p style="font-size: 12px; opacity: 0.8;">
            Comprehensive Health & Fitness Assessment System
        </p>
    </footer>

    <!-- i18n Script -->
    <script src="js/i18n.js"></script>

    <!-- JavaScript Libraries -->
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="js/dataTables.min.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/zangodb.min.js"></script>
    
    <script>
        // ========== MODEL: DATA STORAGE ==========
        const HealthModel = {
            db: null,
            collection: null,
            
            async init() {
                try {
                    if (typeof zango !== 'undefined') {
                        this.db = new zango.Db('HealthFitnessDB', 1, {
                            sessions: ['id', 'timestamp', 'date']
                        });
                        this.collection = this.db.collection('sessions');
                        console.log('ZangoDB initialized successfully');
                    } else {
                        console.warn('ZangoDB not available, using localStorage fallback');
                        this.createFallback();
                    }
                } catch (error) {
                    console.warn('ZangoDB error, using localStorage fallback:', error);
                    this.createFallback();
                }
            },
            
            createFallback() {
                this.collection = {
                    find: (query) => ({ 
                        toArray: async () => {
                            const data = JSON.parse(localStorage.getItem('healthSessions') || '[]');
                            if (!query || Object.keys(query).length === 0) {
                                return data;
                            }
                            return data.filter(session => {
                                for (let key in query) {
                                    if (session[key] !== query[key]) return false;
                                }
                                return true;
                            });
                        }
                    }),
                    insert: async (doc) => {
                        const data = JSON.parse(localStorage.getItem('healthSessions') || '[]');
                        data.push(doc);
                        localStorage.setItem('healthSessions', JSON.stringify(data));
                        return doc;
                    },
                    remove: async (query) => {
                        const data = JSON.parse(localStorage.getItem('healthSessions') || '[]');
                        if (!query || Object.keys(query).length === 0) {
                            localStorage.removeItem('healthSessions');
                            return { deletedCount: data.length };
                        }
                        const initialLength = data.length;
                        const filtered = data.filter(session => session.id !== query.id);
                        localStorage.setItem('healthSessions', JSON.stringify(filtered));
                        return { deletedCount: initialLength - filtered.length };
                    }
                };
            },

            async saveSession(sessionData) {
                const session = {
                    ...sessionData,
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                };
                
                await this.collection.insert(session);
                return session;
            },

            async getSessions(limit = 100) {
                try {
                    const sessions = await this.collection.find({}).toArray();
                    console.log('Raw sessions from DB:', sessions); // DEBUG
                    
                    if (!Array.isArray(sessions)) {
                        console.warn('Sessions is not an array:', sessions);
                        return [];
                    }
                    
                    return sessions
                        .filter(session => session && typeof session === 'object')
                        .sort((a, b) => {
                            const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                            const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                            return dateB - dateA;
                        })
                        .slice(0, limit);
                } catch (error) {
                    console.error('Error getting sessions:', error);
                    return [];
                }
            },
            
            async getLatestSession() {
                const sessions = await this.getSessions(1);
                return sessions[0] || null;
            },
            
            async getSession(id) {
                const sessions = await this.collection.find({ id }).toArray();
                return sessions[0] || null;
            },
            
            async deleteSession(id) {
                await this.collection.remove({ id });
            },
            
            async clearAllSessions() {
                await this.collection.remove();
            },
            
            async getFilteredSessions(filter) {
                const sessions = await this.getSessions();
                const now = new Date();
                
                switch(filter) {
                    case 'last7':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return sessions.filter(s => new Date(s.timestamp) >= weekAgo);
                    case 'last30':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return sessions.filter(s => new Date(s.timestamp) >= monthAgo);
                    case 'last90':
                        const quarterAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        return sessions.filter(s => new Date(s.timestamp) >= quarterAgo);
                    default:
                        return sessions;
                }
            }
        };

        // ========== MODEL: FITNESS CALCULATIONS ==========
        const FitnessCalculator = {
            // ... (ALL YOUR EXISTING CALCULATION FUNCTIONS FROM THE ORIGINAL CODE)
            // Body Composition
            calculateBMI(weightKg, heightCm) {
                if (!weightKg || !heightCm || heightCm === 0) return null;
                const heightM = heightCm / 100;
                return (weightKg / (heightM * heightM));
            },

            classifyBMI(bmi) {
                if (!bmi) return { classification: "N/A", className: "", score: 3 };
                if (bmi < 18.5) return { classification: "Underweight", className: "classification-warning", score: 3 };
                if (bmi < 25) return { classification: "Normal", className: "classification-normal", score: 5 };
                if (bmi < 30) return { classification: "Overweight", className: "classification-warning", score: 2 };
                if (bmi < 35) return { classification: "Obesity I", className: "classification-danger", score: 1 };
                if (bmi < 40) return { classification: "Obesity II", className: "classification-danger", score: 0 };
                return { classification: "Obesity III", className: "classification-danger", score: 0 };
            },

            calculateWHR(waistCm, hipCm) {
                if (!waistCm || !hipCm || hipCm === 0) return null;
                return (waistCm / hipCm);
            },

            classifyWHR(whr, sex) {
                if (!whr) return { classification: "N/A", className: "", score: 3 };
                if (sex === 'M') {
                    if (whr < 0.90) return { classification: "Low risk", className: "classification-normal", score: 5 };
                    if (whr < 0.99) return { classification: "Moderate", className: "classification-warning", score: 3 };
                    return { classification: "High risk", className: "classification-danger", score: 1 };
                } else {
                    if (whr < 0.80) return { classification: "Low risk", className: "classification-normal", score: 5 };
                    if (whr < 0.84) return { classification: "Moderate", className: "classification-warning", score: 3 };
                    return { classification: "High risk", className: "classification-danger", score: 1 };
                }
            },

            calculateIdealWeight(heightCm, sex) {
                if (!heightCm) return null;
                let ideal;
                if (sex === 'M') {
                    ideal = 52 + 1.9 * ((heightCm / 2.54) - 60);
                } else {
                    ideal = 49 + 1.7 * ((heightCm / 2.54) - 60);
                }
                return Math.round(ideal * 0.45359237 * 10) / 10;
            },

            calculateBodyDensity(skinfolds, ageYears, sex) {
                const sum = Object.values(skinfolds).reduce((a, b) => a + b, 0);
                let density;
                if (sex === 'M') {
                    density = 1.112 - (0.00043499 * sum) + (0.00000055 * Math.pow(sum, 2)) - (0.00028826 * ageYears);
                } else {
                    density = 1.097 - (0.00046971 * sum) + (0.00000056 * Math.pow(sum, 2)) - (0.00012828 * ageYears);
                }
                return Math.max(1.02, Math.min(1.10, Math.round(density * 10000) / 10000));
            },

            calculateBodyFatPercentFromDensity(density) {
                if (!density) return null;
                const percent = ((495 / density) - 450);
                return percent > 0 ? percent : 0;
            },

            calculateBoneMass(heightCm, diameterRadioCm, diameterFemurCm, sex) {
                if (!heightCm || !diameterRadioCm || !diameterFemurCm) return null;
                const factor = (sex === 'M') ? 3.02 : 2.58;
                const boneMass = (diameterRadioCm * diameterFemurCm * heightCm * factor) / 1000;
                return Math.max(2.0, Math.min(15.0, Math.round(boneMass * 10) / 10));
            },

            // Health Metrics
            calculateBMR(weightKg, heightCm, ageYears, sex) {
                if (!weightKg || !heightCm || !ageYears) return null;
                if (sex === 'M') {
                    return Math.round(88.362 + (13.397 * weightKg) + (4.799 * heightCm) - (5.677 * ageYears));
                } else {
                    return Math.round(447.593 + (9.247 * weightKg) + (3.098 * heightCm) - (4.330 * ageYears));
                }
            },

            classifyBloodPressure(sys, dia) {
                if (!sys || !dia) return { classification: "N/A", className: "", score: 3 };
                if (sys < 120 && dia < 80) return { classification: "Normal", className: "classification-normal", score: 5 };
                if (sys < 130 && dia < 80) return { classification: "Elevated", className: "classification-warning", score: 4 };
                if (sys < 140 || dia < 90) return { classification: "Stage 1", className: "classification-warning", score: 2 };
                return { classification: "Stage 2", className: "classification-danger", score: 1 };
            },

            classifyCholesterol(total) {
                if (!total) return { classification: "N/A", className: "", score: 3 };
                if (total < 200) return { classification: "Desirable", className: "classification-normal", score: 5 };
                if (total < 240) return { classification: "Borderline", className: "classification-warning", score: 3 };
                return { classification: "High", className: "classification-danger", score: 1 };
            },

            classifyGlucose(glucose) {
                if (!glucose) return { classification: "N/A", className: "", score: 3 };
                if (glucose < 100) return { classification: "Normal", className: "classification-normal", score: 5 };
                if (glucose < 126) return { classification: "Prediabetes", className: "classification-warning", score: 2 };
                return { classification: "Diabetes", className: "classification-danger", score: 0 };
            },

            estimateVO2Max(restingHR, age, sex) {
                if (!restingHR || !age) return null;
                const maxHR = 220 - age;
                const vo2max = 15.3 * (maxHR / restingHR);
                return sex === 'F' ? vo2max * 0.90 : vo2max;
            },

            // Fitness Calculations
            calculateTDEE(bmr, activityLevel) {
                if (!bmr) return null;
                const factors = {
                    'sedentary': 1.2,
                    'light': 1.375,
                    'moderate': 1.55,
                    'active': 1.725,
                    'athlete': 1.9
                };
                return Math.round(bmr * (factors[activityLevel] || 1.2));
            },

            calculateMaxHR(age) {
                return 220 - age;
            },

            calculateTargetHR(restingHR, age, intensityPercent) {
                if (!restingHR || !age) return null;
                const maxHR = this.calculateMaxHR(age);
                const heartRateReserve = maxHR - restingHR;
                return Math.round(restingHR + (heartRateReserve * intensityPercent));
            },

            getTrainingZones(restingHR, age) {
                if (!restingHR || !age) return null;
                const maxHR = this.calculateMaxHR(age);
                const zones = {
                    'Warm-up': [0.50, 0.60],
                    'Fat Burn': [0.60, 0.70],
                    'Aerobic': [0.70, 0.80],
                    'Anaerobic': [0.80, 0.90],
                    'Max Effort': [0.90, 1.00]
                };
                const zoneResults = {};
                for (const [zone, [low, high]] of Object.entries(zones)) {
                    zoneResults[zone] = {
                        low: this.calculateTargetHR(restingHR, age, low),
                        high: this.calculateTargetHR(restingHR, age, high)
                    };
                }
                return zoneResults;
            },

            // Prescription
            prescribeExercises(goal, activityLevel, healthRisks = []) {
                const prescription = {
                    cardio: {},
                    strength: {},
                    recommendations: []
                };

                if (goal === 'fat_loss') {
                    prescription.cardio = {
                        frequency: "5-6 times/week",
                        intensity: "60-75% HRmax",
                        duration: "30-60 minutes",
                        type: "HIIT + Moderate Cardio"
                    };
                    prescription.strength = {
                        frequency: "3-4 times/week",
                        sets: "3-4 per exercise",
                        reps: "12-15",
                        intensity: "60-70% 1RM",
                        rest: "60-90 seconds"
                    };
                    prescription.recommendations = [
                        "Maintain calorie deficit of 300-500 kcal/day",
                        "Include progressive overload in strength training",
                        "Prioritize protein intake (1.6-2.2g/kg)"
                    ];
                } else if (goal === 'muscleGain') {
                    prescription.cardio = {
                        frequency: "2-3 times/week",
                        intensity: "50-65% HRmax",
                        duration: "20-30 minutes",
                        type: "Light Cardio"
                    };
                    prescription.strength = {
                        frequency: "4-5 times/week",
                        sets: "4-5 per exercise",
                        reps: "6-10",
                        intensity: "75-85% 1RM",
                        rest: "90-120 seconds"
                    };
                    prescription.recommendations = [
                        "Calorie surplus of 300-500 kcal/day",
                        "Progressive overload focus",
                        "Prioritize recovery and sleep (7-9 hours)"
                    ];
                } else if (goal === 'cardio' || healthRisks.includes('cardiovascular')) {
                    prescription.cardio = {
                        frequency: "5-7 times/week",
                        intensity: "50-70% HRmax",
                        duration: "30-45 minutes",
                        type: "Steady State Cardio"
                    };
                    prescription.strength = {
                        frequency: "2-3 times/week",
                        sets: "2-3 per exercise",
                        reps: "10-15",
                        intensity: "60-70% 1RM",
                        rest: "60-90 seconds"
                    };
                    prescription.recommendations = [
                        "Focus on consistency over intensity",
                        "Monitor blood pressure during exercise",
                        "Stay hydrated and avoid extreme temperatures"
                    ];
                } else { // Maintenance/Default
                    prescription.cardio = {
                        frequency: "3-4 times/week",
                        intensity: "65-75% HRmax",
                        duration: "30-45 minutes",
                        type: "Moderate Cardio"
                    };
                    prescription.strength = {
                        frequency: "3 times/week",
                        sets: "3-4 per exercise",
                        reps: "8-12",
                        intensity: "70-80% 1RM",
                        rest: "60-90 seconds"
                    };
                    prescription.recommendations = [
                        "Maintain energy balance",
                        "Vary stimuli regularly",
                        "Hydrate adequately"
                    ];
                }

                return prescription;
            },

            calculateStrengthScore(weight, bench, squat) {
                if (!weight || !bench || !squat) return null;
                return ((bench + squat) / weight).toFixed(2);
            }
        };

        // ========== CONTROLLER: APPLICATION LOGIC ==========
        const HealthController = {
            currentSession: null,
            historyChart: null,
            
            init() {
                HealthModel.init();
                this.setupEventListeners();
                this.loadExampleData();
                this.refreshHistory();
            },
            
            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        showTab(this.getAttribute('data-tab'));
                    });
                });
                
                // Set up dynamic prescription inputs
                document.getElementById('prescriptionDynamicInputs').innerHTML = `
                    <div class="form-section">
                        <div class="form-section-title">Prescription Parameters</div>
                        <p><em>Based on data entered in previous tabs. Update those tabs first for accurate prescription.</em></p>
                    </div>
                `;
            },
            
            loadExampleData() {
                // Set example values
                document.getElementById('heightCm').value = '175';
                document.getElementById('weightKg').value = '70';
                document.getElementById('ageYears').value = '30';
                document.getElementById('waistCm').value = '80';
                document.getElementById('hipCm').value = '95';
                document.getElementById('diameterRadio').value = '5.2';
                document.getElementById('diameterFemur').value = '9.5';
                
                document.getElementById('restingHR').value = '65';
                document.getElementById('systolicBP').value = '120';
                document.getElementById('diastolicBP').value = '80';
                document.getElementById('bloodGlucose').value = '95';
                document.getElementById('totalCholesterol').value = '180';
                
                document.getElementById('rmBench').value = '60';
                document.getElementById('rmSquat').value = '80';
            },
            
            updateUserData() {
                const userData = {
                    // Basic info
                    height: parseFloat(document.getElementById('heightCm').value),
                    weight: parseFloat(document.getElementById('weightKg').value),
                    age: parseInt(document.getElementById('ageYears').value),
                    sex: document.getElementById('sex').value,
                    
                    // Composition
                    waist: parseFloat(document.getElementById('waistCm').value),
                    hip: parseFloat(document.getElementById('hipCm').value),
                    diameters: {
                        wrist: parseFloat(document.getElementById('diameterRadio').value),
                        knee: parseFloat(document.getElementById('diameterFemur').value)
                    },
                    skinfolds: {
                        triceps: parseFloat(document.getElementById('sfTriceps').value) || 12,
                        subscapular: parseFloat(document.getElementById('sfSubscapular').value) || 15,
                        axillary: parseFloat(document.getElementById('sfAxillary').value) || 10,
                        pectoral: parseFloat(document.getElementById('sfPectoral').value) || 8,
                        abdominal: parseFloat(document.getElementById('sfAbdominal').value) || 20,
                        suprailiac: parseFloat(document.getElementById('sfSuprailiac').value) || 18,
                        thigh: parseFloat(document.getElementById('sfThigh').value) || 16
                    },
                    
                    // Health metrics
                    restingHR: parseFloat(document.getElementById('restingHR').value),
                    systolicBP: parseFloat(document.getElementById('systolicBP').value),
                    diastolicBP: parseFloat(document.getElementById('diastolicBP').value),
                    bloodGlucose: parseFloat(document.getElementById('bloodGlucose').value),
                    totalCholesterol: parseFloat(document.getElementById('totalCholesterol').value),
                    activityLevel: document.getElementById('activityLevel').value,
                    
                    // Fitness
                    rmBench: parseFloat(document.getElementById('rmBench').value),
                    rmSquat: parseFloat(document.getElementById('rmSquat').value),
                    goal: document.getElementById('goal').value
                };
                
                // Calculate derived metrics
                const bmi = FitnessCalculator.calculateBMI(userData.weight, userData.height);
                const bmiClass = FitnessCalculator.classifyBMI(bmi);
                const whr = FitnessCalculator.calculateWHR(userData.waist, userData.hip);
                const whrClass = FitnessCalculator.classifyWHR(whr, userData.sex);
                const density = FitnessCalculator.calculateBodyDensity(userData.skinfolds, userData.age, userData.sex);
                const bodyFat = FitnessCalculator.calculateBodyFatPercentFromDensity(density);
                const bmr = FitnessCalculator.calculateBMR(userData.weight, userData.height, userData.age, userData.sex);
                const vo2max = FitnessCalculator.estimateVO2Max(userData.restingHR, userData.age, userData.sex);
                const tdee = FitnessCalculator.calculateTDEE(bmr, userData.activityLevel);
                
                this.currentSession = {
                    ...userData,
                    bmi,
                    bmiClass,
                    whr,
                    whrClass,
                    bodyFat,
                    bmr,
                    vo2max,
                    tdee
                };
                
                return this.currentSession;
            },
            
            async saveCurrentSession() {
                if (!this.validateInputs()) {
                    alert('Please fill all required fields (highlighted in red)');
                    return;
                }
                
                try {
                    // 1. Get current data and save
                    const userData = this.updateUserData();
                    const savedSession = await HealthModel.saveSession(userData);
                    
                    console.log('‚úÖ Session saved:', savedSession);
                    
                    // 2. Get updated sessions
                    const updatedSessions = await HealthModel.getSessions();
                    console.log('üìä Total sessions now:', updatedSessions.length);
                    
                    // 3. Destroy existing DataTable
                    if ($.fn.DataTable.isDataTable('#historyTable')) {
                        $('#historyTable').DataTable().destroy();
                        console.log('üóëÔ∏è Destroyed old DataTable');
                    }
                    
                    // 4. Update the table
                    this.updateHistoryTable(updatedSessions);
                    
                    // 5. Update charts
                    this.updateProgressChart(updatedSessions);
                    this.updateComparison(updatedSessions);
                    
                    // 6. Show success
                    this.showSaveSuccess(savedSession);
                    
                    return savedSession;
                    
                } catch (error) {
                    console.error('‚ùå Error saving session:', error);
                    alert('Error saving session. Please try again.');
                }
            },

            showSaveSuccess(session) {
                // Create success notification
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #4cd964;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        animation: slideIn 0.3s ease;
                    ">
                        <i class="fas fa-check-circle" style="font-size: 20px;"></i>
                        <div>
                            <strong>Session Saved!</strong><br>
                            <small>Added to history on ${session.date || 'just now'}</small>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
            },
            
            async loadLatestSession() {
                try {
                    const latestSession = await HealthModel.getLatestSession();
                    if (!latestSession) {
                        alert('No saved sessions found.');
                        return;
                    }
                    
                    this.populateFormWithSession(latestSession);
                    alert(`Loaded session from ${latestSession.date}`);
                } catch (error) {
                    console.error('Error loading session:', error);
                    alert('Error loading session. Please try again.');
                }
            },
            
            populateFormWithSession(session) {
                // Basic info
                if (session.height) document.getElementById('heightCm').value = session.height;
                if (session.weight) document.getElementById('weightKg').value = session.weight;
                if (session.age) document.getElementById('ageYears').value = session.age;
                if (session.sex) document.getElementById('sex').value = session.sex;
                
                // Circumferences
                if (session.waist) document.getElementById('waistCm').value = session.waist;
                if (session.hip) document.getElementById('hipCm').value = session.hip;
                
                // Diameters
                if (session.diameters) {
                    if (session.diameters.wrist) document.getElementById('diameterRadio').value = session.diameters.wrist;
                    if (session.diameters.knee) document.getElementById('diameterFemur').value = session.diameters.knee;
                }
                
                // Skinfolds
                if (session.skinfolds) {
                    if (session.skinfolds.triceps) document.getElementById('sfTriceps').value = session.skinfolds.triceps;
                    if (session.skinfolds.subscapular) document.getElementById('sfSubscapular').value = session.skinfolds.subscapular;
                    if (session.skinfolds.axillary) document.getElementById('sfAxillary').value = session.skinfolds.axillary;
                    if (session.skinfolds.pectoral) document.getElementById('sfPectoral').value = session.skinfolds.pectoral;
                    if (session.skinfolds.abdominal) document.getElementById('sfAbdominal').value = session.skinfolds.abdominal;
                    if (session.skinfolds.suprailiac) document.getElementById('sfSuprailiac').value = session.skinfolds.suprailiac;
                    if (session.skinfolds.thigh) document.getElementById('sfThigh').value = session.skinfolds.thigh;
                }
                
                // Health metrics
                if (session.restingHR) document.getElementById('restingHR').value = session.restingHR;
                if (session.systolicBP) document.getElementById('systolicBP').value = session.systolicBP;
                if (session.diastolicBP) document.getElementById('diastolicBP').value = session.diastolicBP;
                if (session.bloodGlucose) document.getElementById('bloodGlucose').value = session.bloodGlucose;
                if (session.totalCholesterol) document.getElementById('totalCholesterol').value = session.totalCholesterol;
                if (session.activityLevel) document.getElementById('activityLevel').value = session.activityLevel;
                
                // Fitness
                if (session.rmBench) document.getElementById('rmBench').value = session.rmBench;
                if (session.rmSquat) document.getElementById('rmSquat').value = session.rmSquat;
                if (session.goal) document.getElementById('goal').value = session.goal;

                calculateComposition();
                calculateHealthMetrics();
                calculateFitnessAssessment();
                generateComprehensiveSummary();
                generatePrescription();
            },
            
            async refreshHistory() {
                try {
                    const sessions = await HealthModel.getSessions();
                    console.log('Retrieved sessions:', sessions); // DEBUG
                    this.updateHistoryTable(sessions);
                    this.updateProgressChart(sessions);
                    this.updateComparison(sessions);
                } catch (error) {
                    console.error('Error refreshing history:', error);
                    this.updateHistoryTable([]);
                }
            },
            
            async filterHistory() {
                const filter = document.getElementById('historyFilter').value;
                const sessions = await HealthModel.getFilteredSessions(filter);
                this.updateHistoryTable(sessions);
            },
            
            updateHistoryTable(sessions) {
                console.log('=== updateHistoryTable called ===');
                console.log('Sessions count:', sessions ? sessions.length : 0);
                
                const tableBody = document.getElementById('historyTableBody');
                const table = document.getElementById('historyTable');
                
                tableBody.innerHTML = '';
                
                if (!sessions || sessions.length === 0) {
                    console.log('No sessions, showing empty table');
                    
                    tableBody.innerHTML = `
                        <tr>
                            <td>-</td><td>-</td><td>-</td><td>-</td>
                            <td>-</td><td>-</td><td>-</td><td>-</td>
                        </tr>
                        <tr id="emptyMessageRow" style="display: none;">
                            <td colspan="8" style="text-align: center; padding: 40px; color: #666; background: #f9f9f9;">
                                <div style="max-width: 400px; margin: 0 auto;">
                                    <i class="fas fa-clipboard-list" style="font-size: 64px; margin-bottom: 15px; opacity: 0.3; display: block;"></i>
                                    <h3 style="margin: 10px 0; color: #555;">No Assessment History</h3>
                                    <p style="margin: 5px 0; font-size: 14px;">Complete your first health assessment to see your progress here.</p>
                                    <p style="margin: 15px 0 0 0; font-size: 13px; color: #888;">
                                        <i class="fas fa-lightbulb"></i> 
                                        Go to <strong>Body Composition</strong> tab, fill your data and click "Save Session"
                                    </p>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    try {
                        if ($.fn.DataTable.isDataTable('#historyTable')) {
                            $('#historyTable').DataTable().destroy();
                            console.log('Destroyed existing DataTable');
                        }
                    } catch (e) {
                        console.log('No DataTable to destroy');
                    }
                    
                    table.classList.remove('display');
                    table.style.width = '100%';
                    
                    setTimeout(() => {
                        const firstRow = tableBody.querySelector('tr:first-child');
                        const messageRow = document.getElementById('emptyMessageRow');
                        if (firstRow && messageRow) {
                            firstRow.style.display = 'none';
                            messageRow.style.display = '';
                        }
                    }, 50);
                    
                    return;
                }
                
                console.log('Building table with', sessions.length, 'sessions');
                
                sessions.forEach((session, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${session.date || 'N/A'}</td>
                        <td>${session.weight ? session.weight.toFixed(1) : '-'}</td>
                        <td>${session.bmi ? session.bmi.toFixed(1) : '-'}</td>
                        <td>${session.bodyFat ? session.bodyFat.toFixed(1) : '-'}</td>
                        <td>${session.whr ? session.whr.toFixed(2) : '-'}</td>
                        <td>${session.restingHR || '-'}</td>
                        <td>${session.vo2max ? session.vo2max.toFixed(1) : '-'}</td>
                        <td style="white-space: nowrap; min-width: 120px;">
                            <button class="btn-history-action btn-primary btn-icon btn-small" onclick="HealthController.loadSession(${session.id})" title="Load">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn-history-action btn-warning btn-icon btn-small" onclick="HealthController.exportSession(${session.id})" title="Export">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn-history-action btn-danger btn-icon btn-small" onclick="HealthController.deleteSession(${session.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                try {
                    if ($.fn.DataTable.isDataTable('#historyTable')) {
                        $('#historyTable').DataTable().destroy();
                        console.log('Destroyed old DataTable');
                    }
                } catch (e) {
                    console.log('No old DataTable to destroy:', e.message);
                }
                
                try {
                    console.log('Initializing new DataTable...');
                    
                    table.classList.add('display');
                    
                    const dataTable = $('#historyTable').DataTable({
                        searching: true,
                        ordering: true,
                        info: true,
                        paging: sessions.length > 10,
                        pageLength: 10,
                        order: [[0, 'desc']],
                        responsive: false,
                        autoWidth: false,
                        destroy: true,
                        columnDefs: [
                            { width: '150px', targets: 0 }, // Date
                            { width: '100px', targets: 1 }, // Weight
                            { width: '80px', targets: 2 },  // BMI
                            { width: '100px', targets: 3 }, // Body Fat
                            { width: '80px', targets: 4 },  // WHR
                            { width: '100px', targets: 5 }, // Rest HR
                            { width: '100px', targets: 6 }, // VO‚ÇÇ Max
                            { width: '120px', targets: 7, orderable: false }
                        ],
                        language: {
                            emptyTable: "No sessions available",
                            zeroRecords: "No matching sessions found"
                        }
                    });
                    
                    console.log('‚úÖ DataTable initialized successfully with', sessions.length, 'rows');
                    
                } catch (error) {
                    console.error('‚ùå Error initializing DataTable:', error);
                    table.classList.remove('display');
                }
            },
            
            updateProgressChart(sessions) {
                const metric = document.getElementById('chartMetric').value;
                const ctx = document.getElementById('progressChart').getContext('2d');
                
                // Sort sessions by date
                const sortedSessions = [...sessions].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                const labels = sortedSessions.map(s => {
                    const date = new Date(s.timestamp);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                let data = [];
                let label = '';
                let unit = '';
                
                switch(metric) {
                    case 'weight':
                        data = sortedSessions.map(s => s.weight);
                        label = 'Weight';
                        unit = 'kg';
                        break;
                    case 'bmi':
                        data = sortedSessions.map(s => s.bmi);
                        label = 'BMI';
                        unit = '';
                        break;
                    case 'bodyfat':
                        data = sortedSessions.map(s => s.bodyFat);
                        label = 'Body Fat';
                        unit = '%';
                        break;
                    case 'whr':
                        data = sortedSessions.map(s => s.whr);
                        label = 'Waist-Hip Ratio';
                        unit = '';
                        break;
                    case 'restingHR':
                        data = sortedSessions.map(s => s.restingHR);
                        label = 'Resting Heart Rate';
                        unit = 'bpm';
                        break;
                    case 'vo2max':
                        data = sortedSessions.map(s => s.vo2max);
                        label = 'VO‚ÇÇ Max';
                        unit = 'ml/kg/min';
                        break;
                }
                
                // Destroy existing chart
                if (this.historyChart) {
                    this.historyChart.destroy();
                }
                
                // Create new chart
                this.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${label} (${unit})`,
                            data: data,
                            borderColor: '#007aff',
                            backgroundColor: 'rgba(0, 122, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: true
                                }
                            },
                            y: {
                                beginAtZero: false,
                                grid: {
                                    display: true
                                }
                            }
                        }
                    }
                });
            },
            
            updateComparison(sessions) {
                if (sessions.length < 2) {
                    document.getElementById('comparisonWeight').textContent = '-';
                    document.getElementById('comparisonWeightChange').textContent = 'Need at least 2 sessions';
                    document.getElementById('comparisonBodyfat').textContent = '-';
                    document.getElementById('comparisonBodyfatChange').textContent = 'Need at least 2 sessions';
                    document.getElementById('comparisonBMI').textContent = '-';
                    document.getElementById('comparisonBMIChange').textContent = 'Need at least 2 sessions';
                    document.getElementById('comparisonWHR').textContent = '-';
                    document.getElementById('comparisonWHRChange').textContent = 'Need at least 2 sessions';
                    return;
                }
                
                const latest = sessions[0];
                const previous = sessions[1];
                
                // Weight comparison
                if (latest.weight && previous.weight) {
                    const change = latest.weight - previous.weight;
                    const changePercent = ((change / previous.weight) * 100).toFixed(1);
                    document.getElementById('comparisonWeight').textContent = `${latest.weight.toFixed(1)} kg`;
                    document.getElementById('comparisonWeightChange').innerHTML = `
                        ${change > 0 ? '+' : ''}${change.toFixed(1)} kg 
                        <span class="${change > 0 ? 'positive-change' : change < 0 ? 'negative-change' : 'no-change'}">
                            (${change > 0 ? '+' : ''}${changePercent}%)
                        </span>
                    `;
                }
                
                // Body fat comparison
                if (latest.bodyFat && previous.bodyFat) {
                    const change = latest.bodyFat - previous.bodyFat;
                    const changePercent = ((change / previous.bodyFat) * 100).toFixed(1);
                    document.getElementById('comparisonBodyfat').textContent = `${latest.bodyFat.toFixed(1)}%`;
                    document.getElementById('comparisonBodyfatChange').innerHTML = `
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}% 
                        <span class="${change > 0 ? 'negative-change' : change < 0 ? 'positive-change' : 'no-change'}">
                            (${change > 0 ? '+' : ''}${changePercent}%)
                        </span>
                    `;
                }
                
                // BMI comparison
                if (latest.bmi && previous.bmi) {
                    const change = latest.bmi - previous.bmi;
                    document.getElementById('comparisonBMI').textContent = latest.bmi.toFixed(1);
                    document.getElementById('comparisonBMIChange').innerHTML = `
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}
                        <span class="${change > 0 ? 'negative-change' : change < 0 ? 'positive-change' : 'no-change'}">
                            ${change > 0 ? 'Increase' : change < 0 ? 'Decrease' : 'No change'}
                        </span>
                    `;
                }
                
                // WHR comparison
                if (latest.whr && previous.whr) {
                    const change = latest.whr - previous.whr;
                    document.getElementById('comparisonWHR').textContent = latest.whr.toFixed(2);
                    document.getElementById('comparisonWHRChange').innerHTML = `
                        ${change > 0 ? '+' : ''}${change.toFixed(2)}
                        <span class="${change > 0 ? 'negative-change' : change < 0 ? 'positive-change' : 'no-change'}">
                            ${change > 0 ? 'Increase' : change < 0 ? 'Decrease' : 'No change'}
                        </span>
                    `;
                }
            },
            
            async loadSession(id) {
                try {
                    const session = await HealthModel.getSession(id);
                    if (session) {
                        this.populateFormWithSession(session);
                        alert(`Loaded session from ${session.date}`);
                        showTab('composition');
                    }
                } catch (error) {
                    console.error('Error loading session:', error);
                    alert('Error loading session. Please try again.');
                }
            },
            
            async deleteSession(id) {
                if (!confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    console.log('üîÑ DELETE PROCESS START - ID:', id);
                    
                    // 1. Delete from database
                    await HealthModel.deleteSession(id);
                    console.log('‚úÖ Deleted from database');
                    
                    // 2. Get UPDATED sessions
                    const updatedSessions = await HealthModel.getSessions();
                    console.log('üìä Updated sessions count:', updatedSessions.length);
                    
                    // 3. DESTROY existing DataTable
                    if ($.fn.DataTable.isDataTable('#historyTable')) {
                        console.log('üóëÔ∏è Destroying existing DataTable...');
                        $('#historyTable').DataTable().destroy();
                    }
                    
                    // 4. Completely rebuild the table
                    console.log('üî® Rebuilding table...');
                    this.updateHistoryTable(updatedSessions);
                    
                    // 5. Update charts and comparison
                    this.updateProgressChart(updatedSessions);
                    this.updateComparison(updatedSessions);
                    
                    console.log('‚úÖ DELETE PROCESS COMPLETE');
                    
                    // Show success message
                    this.showNotification('Session deleted successfully!', 'success');

                } catch (error) {
                    console.error('Error deleting session:', error);
                    this.showNotification('Error deleting session. Please try again.', 'error');
                }
            },

            showNotification(message, type = 'info') {
                const oldNotification = document.querySelector('.data-notification');
                if (oldNotification) {
                    oldNotification.remove();
                }
                
                const notification = document.createElement('div');
                notification.className = `data-notification ${type}`;
                notification.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 12px 20px;
                        background: ${type === 'success' ? '#4cd964' : type === 'error' ? '#ff3b30' : '#007aff'};
                        color: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        animation: slideIn 0.3s ease;
                    ">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.animation = 'slideOut 0.3s ease';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 3000);
                
                if (!document.querySelector('#notification-styles')) {
                    const style = document.createElement('style');
                    style.id = 'notification-styles';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            },

            async clearAllHistory() {
                if (confirm('Are you sure you want to delete ALL saved sessions? This action cannot be undone.')) {
                    try {
                        await HealthModel.clearAllSessions();
                        this.refreshHistory();
                        alert('All sessions deleted successfully.');
                    } catch (error) {
                        console.error('Error clearing history:', error);
                        alert('Error clearing history. Please try again.');
                    }
                }
            },
            
            async exportHistoryToCSV() {
                try {
                    const sessions = await HealthModel.getSessions();
                    if (sessions.length === 0) {
                        alert('No sessions to export.');
                        return;
                    }
                    
                    // Create CSV header
                    const headers = ['Date', 'Weight (kg)', 'BMI', 'Body Fat %', 'WHR', 'Resting HR', 'VO‚ÇÇ Max', 'BMR', 'TDEE'];
                    
                    // Create CSV rows
                    const rows = sessions.map(session => [
                        session.date,
                        session.weight ? session.weight.toFixed(1) : '',
                        session.bmi ? session.bmi.toFixed(1) : '',
                        session.bodyFat ? session.bodyFat.toFixed(1) : '',
                        session.whr ? session.whr.toFixed(2) : '',
                        session.restingHR || '',
                        session.vo2max ? session.vo2max.toFixed(1) : '',
                        session.bmr || '',
                        session.tdee || ''
                    ]);
                    
                    // Combine header and rows
                    const csvContent = [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `health-fitness-history-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert(`Exported ${sessions.length} sessions to CSV.`);
                } catch (error) {
                    console.error('Error exporting to CSV:', error);
                    alert('Error exporting data. Please try again.');
                }
            },
            
            async exportHistoryToJSON() {
                try {
                    const sessions = await HealthModel.getSessions();
                    if (sessions.length === 0) {
                        alert('No sessions to export.');
                        return;
                    }
                    
                    // Create comprehensive JSON with metadata
                    const exportData = {
                        exportDate: new Date().toISOString(),
                        exportVersion: '1.0',
                        totalSessions: sessions.length,
                        sessions: sessions
                    };
                    
                    const jsonContent = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `health-fitness-history-${new Date().toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert(`Successfully exported ${sessions.length} sessions to JSON.`);
                } catch (error) {
                    console.error('Error exporting to JSON:', error);
                    alert('Error exporting data. Please try again.');
                }
            },
            
            async importHistoryFromJSON() {
                return new Promise((resolve) => {
                    // Create file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.json';
                    fileInput.style.display = 'none';
                    
                    fileInput.addEventListener('change', async (event) => {
                        const file = event.target.files[0];
                        if (!file) {
                            resolve(false);
                            return;
                        }
                        
                        try {
                            const text = await file.text();
                            const importData = JSON.parse(text);
                            
                            // Validate import data structure
                            if (!importData.sessions || !Array.isArray(importData.sessions)) {
                                alert('Invalid file format. No sessions found in the file.');
                                resolve(false);
                                return;
                            }
                            
                            // Ask for import mode
                            const importMode = confirm(
                                `Found ${importData.sessions.length} sessions in the file.\n\n` +
                                'Click OK to MERGE with existing data (keep both).\n' +
                                'Click Cancel to REPLACE existing data (overwrite).'
                            ) ? 'merge' : 'replace';
                            
                            if (!confirm(`Are you sure you want to ${importMode} ${importData.sessions.length} sessions?`)) {
                                resolve(false);
                                return;
                            }
                            
                            let importedCount = 0;
                            let skippedCount = 0;
                            
                            if (importMode === 'replace') {
                                // Clear existing data first
                                await HealthModel.clearAllSessions();
                            }
                            
                            // Import each session
                            for (const session of importData.sessions) {
                                try {
                                    // Check for duplicate sessions in merge mode
                                    if (importMode === 'merge') {
                                        const existingSessions = await HealthModel.getSessions();
                                        const isDuplicate = existingSessions.some(existing => 
                                            existing.id === session.id || 
                                            (existing.timestamp && session.timestamp && 
                                            existing.timestamp === session.timestamp)
                                        );
                                        
                                        if (isDuplicate) {
                                            skippedCount++;
                                            continue;
                                        }
                                    }
                                    
                                    // Generate new ID and timestamp if missing
                                    const sessionToImport = {
                                        ...session,
                                        id: session.id || Date.now() + Math.random(),
                                        timestamp: session.timestamp || new Date().toISOString(),
                                        date: session.date || new Date().toLocaleDateString('en-US', {
                                            year: 'numeric',
                                            month: 'short',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })
                                    };
                                    
                                    await HealthModel.collection.insert(sessionToImport);
                                    importedCount++;
                                    
                                } catch (sessionError) {
                                    console.error('Error importing session:', sessionError);
                                    skippedCount++;
                                }
                            }
                            
                            // Refresh the UI
                            await this.refreshHistory();
                            
                            // Show import summary
                            let message = `Import completed!\n\nImported: ${importedCount} sessions`;
                            if (skippedCount > 0) {
                                message += `\nSkipped: ${skippedCount} sessions (duplicates or errors)`;
                            }
                            if (importMode === 'merge') {
                                message += '\n\nMode: Merged with existing data';
                            } else {
                                message += '\n\nMode: Replaced existing data';
                            }
                            
                            alert(message);
                            resolve(true);
                            
                        } catch (error) {
                            console.error('Error importing JSON:', error);
                            alert('Error importing file. Please check the file format and try again.');
                            resolve(false);
                        }
                        
                        // Clean up
                        document.body.removeChild(fileInput);
                    });
                    
                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                });
            },
            
            async exportSession(id) {
                try {
                    const session = await HealthModel.getSession(id);
                    if (!session) {
                        alert('Session not found.');
                        return;
                    }
                    
                    const jsonContent = JSON.stringify(session, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `health-session-${new Date(session.timestamp).toISOString().split('T')[0]}.json`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('Session exported successfully.');
                } catch (error) {
                    console.error('Error exporting session:', error);
                    alert('Error exporting session. Please try again.');
                }
            },
            
            validateInputs() {
                let isValid = true;
                document.querySelectorAll('[data-validate="true"]').forEach(input => {
                    if (!input.value || isNaN(input.value)) {
                        input.classList.add('validation-error');
                        isValid = false;
                    } else {
                        input.classList.remove('validation-error');
                    }
                });
                return isValid;
            }
        };

        // ========== VIEW: UI FUNCTIONS ==========
        function toggleAccordion(header) {
            const accordion = header.parentElement;
            const content = header.nextElementSibling;
            accordion.classList.toggle('active');
            content.classList.toggle('active');
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            const content = document.getElementById(`tab-${tabId}`);
            if (content) content.classList.add('active');
            const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if (tabBtn) tabBtn.classList.add('active');
        }

        // ========== COMPATIBILITY WITH ORIGINAL FUNCTIONS ==========
        // Keep original functions for compatibility
        function calculateComposition() {
            HealthController.updateUserData();
            
            // Use existing calculation logic
            const userData = HealthController.currentSession;
            
            if (!userData) return;
            
            // Calculate all metrics
            const bmi = FitnessCalculator.calculateBMI(userData.weight, userData.height);
            const bmiClass = FitnessCalculator.classifyBMI(bmi);
            const whr = FitnessCalculator.calculateWHR(userData.waist, userData.hip);
            const whrClass = FitnessCalculator.classifyWHR(whr, userData.sex);
            const density = FitnessCalculator.calculateBodyDensity(userData.skinfolds, userData.age, userData.sex);
            const bodyFat = FitnessCalculator.calculateBodyFatPercentFromDensity(density);
            const idealWeight = FitnessCalculator.calculateIdealWeight(userData.height, userData.sex);
            const boneMass = FitnessCalculator.calculateBoneMass(userData.height, userData.diameters.wrist, userData.diameters.knee, userData.sex);
            
            // Body composition breakdown
            const fatMass = parseFloat((userData.weight * bodyFat / 100).toFixed(1));
            const estimatedResidual = userData.weight * 0.15;
            let muscleMass = userData.weight - fatMass - boneMass - estimatedResidual;
            muscleMass = Math.max(0, muscleMass);
            const residualWeight = userData.weight - (fatMass + boneMass + muscleMass);
            
            // Display results
            document.getElementById('resultBmi').textContent = bmi ? bmi.toFixed(1) : '-';
            document.getElementById('resultWhr').textContent = whr ? whr.toFixed(2) : '-';
            document.getElementById('resultBodyfatPercent').textContent = bodyFat ? `${bodyFat.toFixed(1)}%` : '-';
            document.getElementById('resultIdealWeight').textContent = idealWeight ? `${idealWeight} kg` : '-';
            
            const bmiClassElem = document.getElementById('bmiClassification');
            bmiClassElem.textContent = bmiClass.classification;
            bmiClassElem.className = `classification ${bmiClass.className}`;
            
            const whrClassElem = document.getElementById('whrClassification');
            whrClassElem.textContent = whrClass.classification;
            whrClassElem.className = `classification ${whrClass.className}`;
            
            // Composition table
            document.getElementById('compTotalWeight').textContent = `${userData.weight.toFixed(1)} kg`;
            document.getElementById('compFatMass').textContent = `${fatMass.toFixed(1)} kg`;
            document.getElementById('compBoneMass').textContent = `${boneMass.toFixed(1)} kg`;
            document.getElementById('compMuscleMass').textContent = `${muscleMass.toFixed(1)} kg`;
            document.getElementById('compResidualWeight').textContent = `${Math.max(0, residualWeight).toFixed(1)} kg`;
            
            document.getElementById('compFatPercent').textContent = `${((fatMass / userData.weight) * 100).toFixed(1)}%`;
            document.getElementById('compBonePercent').textContent = `${((boneMass / userData.weight) * 100).toFixed(1)}%`;
            document.getElementById('compMusclePercent').textContent = `${((muscleMass / userData.weight) * 100).toFixed(1)}%`;
            document.getElementById('compResidualPercent').textContent = `${((Math.max(0, residualWeight) / userData.weight) * 100).toFixed(1)}%`;
            
            document.getElementById('resultsComposition').style.display = 'block';
        
            I18NHealth.init();
        }

        function calculateHealthMetrics() {
            HealthController.updateUserData();
            
            const userData = HealthController.currentSession;
            if (!userData) return;
            
            const bmr = FitnessCalculator.calculateBMR(userData.weight, userData.height, userData.age, userData.sex);
            const vo2max = FitnessCalculator.estimateVO2Max(userData.restingHR, userData.age, userData.sex);
            const bpClass = FitnessCalculator.classifyBloodPressure(userData.systolicBP, userData.diastolicBP);
            const cholClass = FitnessCalculator.classifyCholesterol(userData.totalCholesterol);
            const glucoseClass = FitnessCalculator.classifyGlucose(userData.bloodGlucose);
            
            // Display results
            document.getElementById('resultBMR').textContent = bmr || '-';
            document.getElementById('resultVO2Max').textContent = vo2max ? vo2max.toFixed(1) : '-';
            document.getElementById('resultBP').textContent = userData.systolicBP && userData.diastolicBP ? 
                `${userData.systolicBP}/${userData.diastolicBP}` : '-';
            document.getElementById('resultCholesterol').textContent = userData.totalCholesterol || '-';
            
            const bpClassElem = document.getElementById('bpClassification');
            bpClassElem.textContent = bpClass.classification;
            bpClassElem.className = `classification ${bpClass.className}`;
            
            const cholClassElem = document.getElementById('cholClassification');
            cholClassElem.textContent = cholClass.classification;
            cholClassElem.className = `classification ${cholClass.className}`;
            
            // Health assessment
            const assessmentHTML = `
                <div class="metric-row">
                    <span class="metric-name">Cardiovascular Risk:</span>
                    <span class="metric-value ${bpClass.className}">${bpClass.classification}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Cholesterol Level:</span>
                    <span class="metric-value ${cholClass.className}">${cholClass.classification}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Blood Glucose:</span>
                    <span class="metric-value ${glucoseClass.className}">${glucoseClass.classification}</span>
                </div>
                <div class="metric-row">
                    <span class="metric-name">Estimated VO‚ÇÇ Max:</span>
                    <span class="metric-value">${vo2max ? vo2max.toFixed(1) + ' ml/kg/min' : 'N/A'}</span>
                </div>
            `;
            
            document.getElementById('healthAssessment').innerHTML = assessmentHTML;
            document.getElementById('resultsHealth').style.display = 'block';
        
            I18NHealth.init();
        }

        function calculateFitnessAssessment() {
            HealthController.updateUserData();
            
            const userData = HealthController.currentSession;
            if (!userData) return;
            
            const maxHR = FitnessCalculator.calculateMaxHR(userData.age);
            const zones = FitnessCalculator.getTrainingZones(userData.restingHR, userData.age);
            const bmr = FitnessCalculator.calculateBMR(userData.weight, userData.height, userData.age, userData.sex);
            const tdee = FitnessCalculator.calculateTDEE(bmr, userData.activityLevel);
            const strengthScore = FitnessCalculator.calculateStrengthScore(userData.weight, userData.rmBench, userData.rmSquat);
            
            // Display results
            document.getElementById('resultMaxHR').textContent = maxHR || '-';
            document.getElementById('resultTargetHR').textContent = zones ? `${zones['Aerobic'].low}-${zones['Aerobic'].high} bpm` : '-';
            document.getElementById('resultTDEE').textContent = tdee || '-';
            document.getElementById('resultStrengthScore').textContent = strengthScore || '-';
            
            // Zone visualization
            if (zones) {
                let zoneHTML = '';
                let detailsHTML = '<table><tr><th>Zone</th><th>Heart Rate Range</th><th>Intensity</th></tr>';
                
                const zoneColors = {
                    'Warm-up': '#4cd964',
                    'Fat Burn': '#5ac8fa',
                    'Aerobic': '#007aff',
                    'Anaerobic': '#ff9500',
                    'Max Effort': '#ff3b30'
                };
                
                Object.entries(zones).forEach(([zone, range]) => {
                    const width = 20; // Each zone gets 20% width
                    zoneHTML += `
                        <div class="zone-segment" style="width:${width}%; background:${zoneColors[zone]};">
                            <div class="zone-label">${zone}</div>
                        </div>
                    `;
                    
                    detailsHTML += `
                        <tr>
                            <td><span style="display:inline-block;width:12px;height:12px;background:${zoneColors[zone]};margin-right:8px;"></span>${zone}</td>
                            <td>${range.low} - ${range.high} bpm</td>
                            <td>${zone === 'Warm-up' ? 'Very Light' : 
                                 zone === 'Fat Burn' ? 'Light' : 
                                 zone === 'Aerobic' ? 'Moderate' :
                                 zone === 'Anaerobic' ? 'Hard' : 'Maximum'}</td>
                        </tr>
                    `;
                });
                
                detailsHTML += '</table>';
                
                document.getElementById('zoneVisualization').innerHTML = `<div class="zone-bar">${zoneHTML}</div>`;
                document.getElementById('zoneDetails').innerHTML = detailsHTML;
            }
            
            document.getElementById('resultsFitness').style.display = 'block';
        
            I18NHealth.init();
        }

        function generatePrescription() {
            HealthController.updateUserData();
            
            const userData = HealthController.currentSession;
            if (!userData) return;
            
            // Calculate metrics for prescription
            const bmr = FitnessCalculator.calculateBMR(userData.weight, userData.height, userData.age, userData.sex);
            const tdee = FitnessCalculator.calculateTDEE(bmr, userData.activityLevel);
            
            // Determine health risks
            const healthRisks = [];
            const bpClass = FitnessCalculator.classifyBloodPressure(userData.systolicBP, userData.diastolicBP);
            if (bpClass.score < 3) healthRisks.push('cardiovascular');
            
            const cholClass = FitnessCalculator.classifyCholesterol(userData.totalCholesterol);
            if (cholClass.score < 3) healthRisks.push('cholesterol');
            
            // Generate prescription
            const prescription = FitnessCalculator.prescribeExercises(userData.goal, userData.activityLevel, healthRisks);
            
            // Calculate caloric targets
            let caloricTarget;
            switch(userData.goal) {
                case 'fat_loss':
                    caloricTarget = tdee - 500;
                    break;
                case 'muscleGain':
                    caloricTarget = tdee + 300;
                    break;
                default:
                    caloricTarget = tdee;
            }
            
            // Timeframe estimation
            let timeframe;
            let weeklyGoal;
            switch(userData.goal) {
                case 'fat_loss':
                    timeframe = '12-16 weeks';
                    weeklyGoal = '0.5-1.0 kg loss';
                    break;
                case 'muscleGain':
                    timeframe = '8-12 weeks';
                    weeklyGoal = '0.2-0.5 kg gain';
                    break;
                case 'strength':
                    timeframe = '6-8 weeks';
                    weeklyGoal = '2-5% strength increase';
                    break;
                default:
                    timeframe = 'Ongoing';
                    weeklyGoal = 'Maintenance';
            }
            
            // Risk score calculation
            const bmi = FitnessCalculator.calculateBMI(userData.weight, userData.height);
            const bmiClass = FitnessCalculator.classifyBMI(bmi);
            const whr = FitnessCalculator.calculateWHR(userData.waist, userData.hip);
            const whrClass = FitnessCalculator.classifyWHR(whr, userData.sex);
            
            const riskScore = Math.round((bmiClass.score + whrClass.score + bpClass.score + cholClass.score) / 4);
            
            // Display prescription
            document.getElementById('resultCaloricTarget').textContent = caloricTarget || '-';
            document.getElementById('resultTimeframe').textContent = timeframe;
            document.getElementById('resultWeeklyGoal').textContent = weeklyGoal;
            document.getElementById('resultRiskScore').textContent = riskScore;
            
            document.getElementById('prescriptionCardio').innerHTML = `
                <p><strong>Frequency:</strong> ${prescription.cardio.frequency}</p>
                <p><strong>Intensity:</strong> ${prescription.cardio.intensity}</p>
                <p><strong>Duration:</strong> ${prescription.cardio.duration}</p>
                <p><strong>Type:</strong> ${prescription.cardio.type}</p>
            `;
            
            document.getElementById('prescriptionStrength').innerHTML = `
                <p><strong>Frequency:</strong> ${prescription.strength.frequency}</p>
                <p><strong>Sets/Reps:</strong> ${prescription.strength.sets} sets of ${prescription.strength.reps} reps</p>
                <p><strong>Intensity:</strong> ${prescription.strength.intensity}</p>
                <p><strong>Rest:</strong> ${prescription.strength.rest}</p>
            `;
            
            document.getElementById('prescriptionRecommendations').innerHTML = `
                <ul>
                    ${prescription.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
            
            document.getElementById('resultsPrescription').style.display = 'block';
        
            I18NHealth.init();
        }

        function generateComprehensiveSummary() {
            HealthController.updateUserData();
            
            const userData = HealthController.currentSession;
            if (!userData) return;
            
            // Calculate all metrics
            const bmi = FitnessCalculator.calculateBMI(userData.weight, userData.height);
            const bmiClass = FitnessCalculator.classifyBMI(bmi);
            const whr = FitnessCalculator.calculateWHR(userData.waist, userData.hip);
            const whrClass = FitnessCalculator.classifyWHR(whr, userData.sex);
            const bpClass = FitnessCalculator.classifyBloodPressure(userData.systolicBP, userData.diastolicBP);
            const cholClass = FitnessCalculator.classifyCholesterol(userData.totalCholesterol);
            const glucoseClass = FitnessCalculator.classifyGlucose(userData.bloodGlucose);
            const vo2max = FitnessCalculator.estimateVO2Max(userData.restingHR, userData.age, userData.sex);
            const bmr = FitnessCalculator.calculateBMR(userData.weight, userData.height, userData.age, userData.sex);
            const tdee = FitnessCalculator.calculateTDEE(bmr, userData.activityLevel);
            
            // Overall score calculation
            const scores = [bmiClass.score, whrClass.score, bpClass.score, cholClass.score, glucoseClass.score];
            const overallScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            
            // Assessment text
            let assessmentText;
            if (overallScore >= 4.5) {
                assessmentText = "Excellent health profile";
            } else if (overallScore >= 3.5) {
                assessmentText = "Good health with minor improvements possible";
            } else if (overallScore >= 2.5) {
                assessmentText = "Moderate health - some areas need attention";
            } else {
                assessmentText = "Needs improvement - consider consulting a healthcare provider";
            }
            
            // Update summary panel
            document.getElementById('overallScore').textContent = overallScore + "/5";
            document.getElementById('overallAssessment').textContent = assessmentText;
            
            // Composition summary
            const density = FitnessCalculator.calculateBodyDensity(userData.skinfolds, userData.age, userData.sex);
            const bodyFat = FitnessCalculator.calculateBodyFatPercentFromDensity(density);
            
            document.getElementById('summaryComposition').innerHTML = `
                <div class="metric-row"><span class="metric-name">BMI:</span><span class="metric-value">${bmi ? bmi.toFixed(1) : '-'} (${bmiClass.classification})</span></div>
                <div class="metric-row"><span class="metric-name">WHR:</span><span class="metric-value">${whr ? whr.toFixed(2) : '-'} (${whrClass.classification})</span></div>
                <div class="metric-row"><span class="metric-name">Body Fat:</span><span class="metric-value">${bodyFat ? bodyFat.toFixed(1) + '%' : '-'}</span></div>
                <div class="metric-row"><span class="metric-name">BMR:</span><span class="metric-value">${bmr || '-'} kcal/day</span></div>
            `;
            
            // Health summary
            document.getElementById('summaryHealth').innerHTML = `
                <div class="metric-row"><span class="metric-name">Blood Pressure:</span><span class="metric-value">${userData.systolicBP && userData.diastolicBP ? `${userData.systolicBP}/${userData.diastolicBP}` : '-'} (${bpClass.classification})</span></div>
                <div class="metric-row"><span class="metric-name">Cholesterol:</span><span class="metric-value">${userData.totalCholesterol || '-'} mg/dL (${cholClass.classification})</span></div>
                <div class="metric-row"><span class="metric-name">Blood Glucose:</span><span class="metric-value">${userData.bloodGlucose || '-'} mg/dL (${glucoseClass.classification})</span></div>
                <div class="metric-row"><span class="metric-name">VO‚ÇÇ Max:</span><span class="metric-value">${vo2max ? vo2max.toFixed(1) + ' ml/kg/min' : '-'}</span></div>
            `;
            
            // Fitness summary
            const strengthScore = FitnessCalculator.calculateStrengthScore(userData.weight, userData.rmBench, userData.rmSquat);
            const maxHR = FitnessCalculator.calculateMaxHR(userData.age);
            
            document.getElementById('summaryFitness').innerHTML = `
                <div class="metric-row"><span class="metric-name">Strength Score:</span><span class="metric-value">${strengthScore || '-'}</span></div>
                <div class="metric-row"><span class="metric-name">Max Heart Rate:</span><span class="metric-value">${maxHR || '-'} bpm</span></div>
                <div class="metric-row"><span class="metric-name">TDEE:</span><span class="metric-value">${tdee || '-'} kcal/day</span></div>
                <div class="metric-row"><span class="metric-name">Activity Level:</span><span class="metric-value">${userData.activityLevel.charAt(0).toUpperCase() + userData.activityLevel.slice(1)}</span></div>
            `;
            
            // Risk factors
            let riskHTML = '';
            if (bmiClass.score < 3) riskHTML += `<li>BMI classification: ${bmiClass.classification}</li>`;
            if (whrClass.score < 3) riskHTML += `<li>Waist-to-hip ratio: ${whrClass.classification}</li>`;
            if (bpClass.score < 3) riskHTML += `<li>Blood pressure: ${bpClass.classification}</li>`;
            if (cholClass.score < 3) riskHTML += `<li>Cholesterol: ${cholClass.classification}</li>`;
            if (glucoseClass.score < 3) riskHTML += `<li>Blood glucose: ${glucoseClass.classification}</li>`;
            
            document.getElementById('summaryRisks').innerHTML = riskHTML ? 
                `<ul>${riskHTML}</ul>` : 
                '<p class="classification-normal">No significant risk factors identified</p>';
        
            I18NHealth.init();
        }

        // ========== ALIAS FUNCTIONS FOR COMPATIBILITY ==========
        function saveCurrentSession() {
            return HealthController.saveCurrentSession();
        }

        function loadLatestSession() {
            return HealthController.loadLatestSession();
        }

        function refreshHistory() {
            return HealthController.refreshHistory();
        }

        function filterHistory() {
            return HealthController.filterHistory();
        }

        function updateProgressChart() {
            return HealthController.refreshHistory();
        }

        function exportHistoryToCSV() {
            return HealthController.exportHistoryToCSV();
        }

        function exportHistoryToJSON() {
            return HealthController.exportHistoryToJSON();
        }

        function importHistoryFromJSON() {
            return HealthController.importHistoryFromJSON();
        }

        function clearAllHistory() {
            return HealthController.clearAllHistory();
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            HealthController.init();
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker successfully registered.'))
            .catch(err => console.error('Erro SW:', err));
        }
    </script>
</body>
</html>